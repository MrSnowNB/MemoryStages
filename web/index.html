<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Stages Chat - Multi-Agent Memory System</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
        }

        header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            color: var(--secondary-color);
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-top: 30px;
        }

        .chat-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
        }

        .info-panel h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .info-panel p {
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .chat-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(90deg, var(--primary-color), #3b82f6);
            color: white;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary-color);
            color: white;
        }

        .message.bot .message-avatar {
            background: var(--success-color);
            color: white;
        }

        .message-content {
            background: #f1f5f9;
            padding: 12px 16px;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            max-width: 100%;
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
            border-bottom-left-radius: 16px;
        }

        .message-meta {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--secondary-color);
            flex-wrap: wrap;
        }

        .confidence {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .confidence.high {
            background: var(--success-color);
            color: white;
        }

        .confidence.medium {
            background: var(--warning-color);
            color: white;
        }

        .confidence.low {
            background: var(--error-color);
            color: white;
        }

        .validation-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .validation-status.validated {
            background: var(--success-color);
            color: white;
        }

        .validation-status.unvalidated {
            background: var(--error-color);
            color: white;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-color);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 44px;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 22px;
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .chat-input:disabled {
            background: #f1f5f9;
            cursor: not-allowed;
        }

        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .send-button:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .status-indicator.healthy {
            background: var(--success-color);
            color: white;
        }

        .status-indicator.unhealthy {
            background: var(--error-color);
            color: white;
        }

        .status-indicator.degraded {
            background: var(--warning-color);
            color: white;
        }

        .agent-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .error-message {
            background: var(--error-color);
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
        }

        .typing-indicator .dot {
            width: 6px;
            height: 6px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }

            header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ§  Memory Stages Chat</h1>
            <p>Experience the power of multi-agent memory systems with Ollama integration</p>
        </header>

        <div class="error-message" id="errorMessage">
            Unable to connect to the chat service. Please check that the server is running.
        </div>

        <div class="layout">
            <div class="chat-section">
                <div class="chat-container">
                    <div class="chat-header">
                        ðŸ¤– Multi-Agent Swarm Chat
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message bot">
                            <div class="message-avatar">AI</div>
                            <div class="message-content">
                                Hello! I'm your multi-agent memory system powered by Ollama. I use multiple AI agents working together to provide accurate, memory-validated responses. What would you like to know?
                            </div>
                        </div>
                    </div>

                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message-avatar">AI</div>
                        <span>Processing your request...</span>
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>

                    <div class="chat-input-area">
                        <textarea
                            class="chat-input"
                            id="messageInput"
                            placeholder="Ask me anything... (e.g., 'What is machine learning?', 'Tell me about Python')"
                            rows="1"
                            maxlength="2000"
                            onkeydown="handleKeyPress(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            <span id="sendIcon">â–¶</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="info-panel">
                <h3>System Status</h3>

                <div class="status-indicator" id="healthIndicator">
                    <div class="loading"></div>
                    <span>Checking system health...</span>
                </div>

                <div class="agent-info" id="agentInfo">
                    <strong>Last Response Info:</strong><br>
                    <span id="lastStats">No responses yet</span>
                </div>

                <h3 style="margin-top: 20px;">How It Works</h3>
                <p>This chatbot uses multiple Ollama AI agents working together through a rule-based orchestrator. Each response is validated against your canonical memory to ensure accuracy and prevent hallucinations.</p>

                <p><strong>Features:</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 15px;">
                    <li>Multi-agent swarm processing</li>
                    <li>Memory-validated responses</li>
                    <li>Real-time confidence scoring</li>
                    <li>Comprehensive audit trails</li>
                    <li>Prompt injection protection</li>
                </ul>

                <h3 style="margin-top: 20px;">Agent Information</h3>
                <p>Click below to learn about each bot/agent in the system:</p>
                <div style="margin: 10px 0;">
                    <button id="toggleAgentInfo" style="background: var(--primary-color); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Show Agent Info</button>
                </div>
                <div id="agentInfoPanel" style="display: none; margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 8px; font-weight: bold;">Agent</th>
                                <th style="text-align: left; padding: 8px; font-weight: bold;">Role</th>
                                <th style="text-align: left; padding: 8px; font-weight: bold;">Code</th>
                            </tr>
                        </thead>
                        <tbody id="agentTableBody">
                            <!-- Agent rows populated by JavaScript -->
                        </tbody>
                    </table>

                    <div style="margin-top: 15px; padding: 10px; background: var(--bg-color); border-radius: 4px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: var(--primary-color);">Agent Details:</h4>
                        <div id="agentDetails" style="font-size: 0.8rem;"></div>
                    </div>
                </div>

                <p><strong>Try asking:</strong></p>
                <ul style="padding-left: 20px;">
                    <li>What programming languages do you know?</li>
                    <li>Tell me about machine learning</li>
                    <li>How does memory validation work?</li>
                    <li>What is the current model being used?</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = "http://localhost:8000"; // Use same host/port as the page
        const HEALTH_CHECK_INTERVAL = 30000; // 30 seconds

        // Global state
        let currentSessionId = null;
        let isTyping = false;

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const sendIcon = document.getElementById('sendIcon');
        const errorMessage = document.getElementById('errorMessage');
        const healthIndicator = document.getElementById('healthIndicator');
        const typingIndicator = document.getElementById('typingIndicator');
        const lastStats = document.getElementById('lastStats');

        // Agent information data
        const agentsInfo = [
            {
                name: "Ollama Agent",
                role: "LLM Generation",
                code: "src/agents/ollama_agent.py",
                description: "Main language generation agent using Ollama API. Handles natural language queries, Q&A, and general explanations. Provides contextual AI responses before memory validation."
            },
            {
                name: "Rule-Based Orchestrator",
                role: "Swarm Coordinator",
                code: "src/agents/orchestrator.py",
                description: "Coordinates multi-agent swarm operations. Routes user queries to appropriate agents (LLM, KV, vector), applies rule-based decision logic, and validates responses against canonical memory."
            },
            {
                name: "Memory Adapter",
                role: "Canonical Memory",
                code: "src/agents/memory_adapter.py",
                description: "Manages validated 'ground truth' memory storage in SQLite. Retrieves exact canonical facts for memory validation, short-circuits agents for direct memory queries."
            },
            {
                name: "FAISS Retriever",
                role: "Vector Search (Planned)",
                code: "src/agents/faiss_adapter.py",
                description: "Future Stage 2 agent for semantic vector search. Will ingest text chunks, store as embeddings, and retrieve top-k similar results for complex contextual queries."
            },
            {
                name: "Agent Registry",
                role: "Agent Management",
                code: "src/agents/registry.py",
                description: "Manages agent lifecycle, initialization, and health monitoring. Creates and tracks Ollama agent instances in the swarm."
            },
            {
                name: "Vector Store",
                role: "Semantic Memory",
                code: "src/vector/faiss_store.py",
                description: "FAISS-based vector storage system. Current implementation handles vector indexing, persistence, and similarity search for long-term semantic memory."
            }
        ];

        let selectedAgentIndex = 0;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            setInterval(checkHealth, HEALTH_CHECK_INTERVAL);

            // Initialize agent info panel
            populateAgentTable();
            setupAgentInfoToggle();
            updateAgentDetails();
        });

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Handle keyboard events
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send a chat message
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || isTyping) return;

            // Reset UI
            hideError();
            disableInput();

            // Add user message to chat
            addMessage('user', content, null, null, false);
            messageInput.value = '';

            // Show typing indicator
            showTyping();

            try {
                const response = await sendChatRequest(content);

                // Hide typing indicator
                hideTyping();

                // Add bot response to chat
                addMessage('bot', response.content, response.confidence,
                         response.validation_passed, true, response);

            } catch (error) {
                hideTyping();
                console.error('Chat error:', error);
                showError(`Failed to send message: ${error.message}`);
            } finally {
                enableInput();
                scrollToBottom();
            }
        }

        // Send chat request to API
        async function sendChatRequest(content) {
            const requestData = {
                content: content,
                user_id: 'web-user'
            };

            // Include session_id if we have one
            if (currentSessionId) {
                requestData.session_id = currentSessionId;
            }

            const response = await fetch(`${API_BASE_URL}/chat/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer web-demo-token'
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            // Store session ID for future requests
            currentSessionId = data.session_id;

            return data;
        }

        // Check system health
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/chat/health`);
                const data = await response.json();

                updateHealthStatus(data);
                hideError();
            } catch (error) {
                console.error('Health check failed:', error);
                updateHealthStatus({ status: 'unhealthy', model: 'unknown', agent_count: 0 });
                showError(`Health check failed: ${error.message}`);
            }
        }

        // Update health status display
        function updateHealthStatus(health) {
            const indicator = healthIndicator;

            // Remove existing status classes
            indicator.className = 'status-indicator';

            // Set status class and text
            switch (health.status) {
                case 'healthy':
                    indicator.classList.add('healthy');
                    indicator.innerHTML = `<span>âœ“ System Healthy</span>`;
                    break;
                case 'degraded':
                    indicator.classList.add('degraded');
                    indicator.innerHTML = `<span>âš  System Degraded</span>`;
                    break;
                default:
                    indicator.classList.add('unhealthy');
                    indicator.innerHTML = `<span>âœ— System Unhealthy</span>`;
            }

            // Add additional info
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <small style="opacity: 0.8;">
                    Model: ${health.model} | Agents: ${health.agent_count}
                </small>
            `;
            indicator.appendChild(infoDiv);
        }

        // Add message to chat
        function addMessage(type, content, confidence, validationPassed, showMeta = false, metadata = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'You' : 'AI';
            messageDiv.appendChild(avatar);

            // Content
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Format content (convert line breaks, etc.)
            contentDiv.innerHTML = formatMessageContent(content);
            messageDiv.appendChild(contentDiv);

            // Metadata for bot messages
            if (type === 'bot' && showMeta) {
                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';

                // Confidence indicator
                if (confidence !== null) {
                    const confSpan = document.createElement('span');
                    confSpan.className = `confidence ${getConfidenceClass(confidence)}`;
                    confSpan.textContent = `${Math.round(confidence * 100)}% confident`;
                    metaDiv.appendChild(confSpan);
                }

                // Validation status - FIXED per CurrentFix1.md
                // Only show "Memory Validated" badge when:
                // 1. Canonical KV read: validationPassed=true AND agents_consulted_count=0
                // 2. Swarm with KV evidence: validationPassed=true AND agents_consulted_count>0 AND memory_sources have KV
                let showValidationBadge = false;

                if (validationPassed && metadata) {
                    if (metadata.agents_consulted_count === 0) {
                        // Canonical KV read
                        showValidationBadge = true;
                    } else if (metadata.agents_consulted_count > 0 && metadata.memory_sources && metadata.memory_sources.length > 0) {
                        // Swarm with KV evidence
                        showValidationBadge = true;
                    }
                }

                if (showValidationBadge) {
                    const valSpan = document.createElement('span');
                    valSpan.className = `validation-status validated`;
                    valSpan.textContent = 'âœ“ Memory Validated';
                    metaDiv.appendChild(valSpan);
                }

                // Agents consulted
                if (metadata && metadata.agents_consulted) {
                    const agentsSpan = document.createElement('span');
                    agentsSpan.textContent = `${metadata.agents_consulted.length} agents consulted`;
                    metaDiv.appendChild(agentsSpan);
                }

                contentDiv.appendChild(metaDiv);
            }

            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            // Update last stats
            if (type === 'bot' && metadata) {
                updateLastStats(metadata);
            }
        }

        // Format message content for display
        function formatMessageContent(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        // Get confidence class for styling
        function getConfidenceClass(confidence) {
            if (confidence >= 0.7) return 'high';
            if (confidence >= 0.4) return 'medium';
            return 'low';
        }

        // Update last response statistics
        function updateLastStats(metadata) {
            let stats = `Confidence: ${Math.round(metadata.confidence * 100)}% | `;
            stats += `Agents: ${metadata.agents_consulted.length} | `;
            stats += `Validation: ${metadata.validation_passed ? 'âœ“' : 'âš '} | `;
            stats += `Processing: ${metadata.processing_time_ms}ms`;

            lastStats.innerHTML = stats;
        }

        // Scroll chat to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show/hide typing indicator
        function showTyping() {
            typingIndicator.style.display = 'flex';
            isTyping = true;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
            isTyping = false;
        }

        // Enable/disable input controls
        function disableInput() {
            messageInput.disabled = true;
            sendButton.disabled = true;
            sendIcon.innerHTML = '<div class="loading"></div>';
        }

        function enableInput() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            sendIcon.textContent = 'â–¶';
            messageInput.focus();
        }

        // Show/hide error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Agent information panel functions
        function populateAgentTable() {
            const tableBody = document.getElementById('agentTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            agentsInfo.forEach((agent, index) => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.style.borderBottom = '1px solid var(--border-color)';

                // Highlight first row (Ollama Agent) by default
                if (index === 0) {
                    row.style.backgroundColor = 'rgba(37, 99, 235, 0.05)';
                }

                row.innerHTML = `
                    <td style="padding: 6px 8px; font-weight: 500; color: var(--primary-color);">${agent.name}</td>
                    <td style="padding: 6px 8px; color: var(--secondary-color);">${agent.role}</td>
                    <td style="padding: 6px 8px; color: var(--secondary-color); font-family: 'Courier New', monospace; font-size: 0.8rem;">${agent.code}</td>
                `;

                // Add click handler to select agent
                row.onclick = () => selectAgent(index);

                tableBody.appendChild(row);
            });
        }

        function selectAgent(index) {
            selectedAgentIndex = index;

            // Update row highlighting
            const rows = document.querySelectorAll('#agentTableBody tr');
            rows.forEach((row, i) => {
                if (i === index) {
                    row.style.backgroundColor = 'rgba(37, 99, 235, 0.05)';
                    row.style.borderLeft = '3px solid var(--primary-color)';
                } else {
                    row.style.backgroundColor = 'transparent';
                    row.style.borderLeft = '3px solid transparent';
                }
            });

            updateAgentDetails();
        }

        function updateAgentDetails() {
            const agent = agentsInfo[selectedAgentIndex];
            const detailsDiv = document.getElementById('agentDetails');

            detailsDiv.innerHTML = `
                <strong>${agent.name}</strong><br>
                <em>${agent.role}</em><br>
                <strong>Code:</strong> <code style="background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 2px; font-size: 0.8rem;">${agent.code}</code><br>
                <br>
                ${agent.description}
            `;
        }

        function setupAgentInfoToggle() {
            const toggleButton = document.getElementById('toggleAgentInfo');
            const panel = document.getElementById('agentInfoPanel');

            toggleButton.onclick = () => {
                const isHidden = panel.style.display === 'none';
                panel.style.display = isHidden ? 'block' : 'none';
                toggleButton.textContent = isHidden ? 'Hide Agent Info' : 'Show Agent Info';
            };
        }

        // Fallback for browsers without fetch (very old browsers)
        if (!window.fetch) {
            showError('Your browser does not support modern web features. Please upgrade to a recent browser.');
        }
    </script>
</body>
</html>
